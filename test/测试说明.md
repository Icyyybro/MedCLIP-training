# MedCLIP MIMIC数据集测试脚本使用说明

## 文件说明

- `test/test_medclip.py`: MIMIC数据集专用测试脚本
- `test/test_config.json`: MIMIC数据集测试配置文件
- `test/install_dependencies.sh`: 依赖安装脚本
- `test/测试说明.md`: 本说明文档

## 安装依赖

### 方法1：使用安装脚本（推荐）

```bash
cd test
bash install_dependencies.sh
```

### 方法2：手动安装

```bash
# 基础依赖（必需）
pip install torch torchvision transformers
pip install pandas numpy pillow scikit-learn

# 可视化依赖（可选，用于生成图表）
pip install matplotlib seaborn
```

**注意：** 如果没有安装可视化依赖，测试脚本仍能正常运行，只是不会生成图表文件。

## 使用方法

### 方法1：从项目根目录运行（推荐）

```bash
# 快速测试（验证模型基本功能）
python run_test.py --quick

# MIMIC数据集测试
python run_test.py

# 指定检查点
python run_test.py --checkpoint /path/to/your/checkpoint.pth
```

### 方法2：直接进入test目录运行

```bash
cd test

# 快速测试（推荐先运行）
python test_medclip.py --quick

# MIMIC数据集测试
python test_medclip.py

# 使用自定义配置文件
python test_medclip.py --config test_config.json

# 指定检查点
python test_medclip.py --checkpoint /path/to/your/checkpoint.pth
```

## 测试功能

- **快速测试** (`--quick`): 验证模型基本功能（图像编码、文本编码、相似度计算）
- **MIMIC数据集测试**: 在MIMIC数据集上进行图像-文本检索测试，计算Recall@K指标

## 配置说明

修改 `test_config.json` 中的配置：

- `checkpoint_path`: 模型检查点路径
- `test_batch_size`: 测试批次大小
- `data_path`: MIMIC数据集pkl文件路径
- `use_mimic_dataset`: 是否启用MIMIC数据集测试
- `class_names`: 分类类别名称（14个CheXpert类别）

## 输出结果

测试结果会保存在 `./test_results_mimic/` 目录下：

- 日志文件：`logs/test_YYYYMMDD_HHMMSS.log`
- 结果文件：`mimic_dataset_results_YYYYMMDD_HHMMSS.json`
- 可视化图表：`mimic_retrieval_results.png`

## 注意事项

1. 确保GPU内存足够（建议8GB+）
2. 检查模型路径和数据集路径是否正确
3. 快速测试失败时，完整测试不会执行
4. 结果会自动保存，便于后续分析
